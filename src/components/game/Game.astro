---
import ArrowBox from "./ArrowBox.astro";
import TargetBox from "./TargetBox.astro";
// import ClickSound from "./spacebar-click-keyboard-199448.mp3";
// import CorrectSound from "./path/to/correct-sound.mp3";
// import WrongSound from "./path/to/wrong-sound.mp3";

// Generate 10 random arrow
const arrows = ["up", "down", "left", "right"] as const;
const randomArrows = Array.from({ length: 10 }, (_, index) => ({
  direction: arrows[Math.floor(Math.random() * arrows.length)],
  class: `game__arrow-box game__arrow-box--${index + 1}`,
}));
---

<div class="game" data-arrows={randomArrows}>
  <div class="game__Arrow-Container">
    <TargetBox>
      {
        randomArrows.map(({ direction, class: className }) => (
          <ArrowBox arrow={direction} class={className} />
        ))
      }
    </TargetBox>
  </div>

  <button class="game__button--start">Start</button>
  <button class="game__button--measure">Measure</button>
  <button class="game__button--reset">Reset</button>
</div>

<script>
  // Importer les sons
  import ClickSound from "./spacebar-click-keyboard-199448.mp3";
  import CorrectSound from "./sword-sound-effect-1-full-pack-on-gamesfxpackscom-234987.mp3";
  import WrongSound from "./male_hurt7-48124.mp3";

  // Créer un contexte audio
  const audioContext = new window.AudioContext();
  const soundBuffers: Record<string, AudioBuffer> = {};

  // Fonction pour charger un son
  async function loadSound(url: string) {
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    return await audioContext.decodeAudioData(arrayBuffer);
  }

  // Charger tous les sons
  Promise.all([
    loadSound(ClickSound),
    loadSound(CorrectSound),
    loadSound(WrongSound),
  ]).then(([clickBuffer, correctBuffer, wrongBuffer]) => {
    soundBuffers.click = clickBuffer;
    soundBuffers.correct = correctBuffer;
    soundBuffers.wrong = wrongBuffer;
  });

  // Fonction pour jouer un son
  function playSound(soundName: string) {
    if (soundBuffers[soundName]) {
      const source = audioContext.createBufferSource();
      source.buffer = soundBuffers[soundName];
      source.connect(audioContext.destination);
      source.start(0);
    }
  }

  // GET ARROWS SEQUENCE
  const gameArrows = document.querySelectorAll(".arrow-box__arrow");
  const randomArrows = Array.from(gameArrows)
    .map((arrow) => {
      const className = arrow.className;
      if (className.includes("left")) return "ArrowLeft";
      if (className.includes("up")) return "ArrowUp";
      if (className.includes("down")) return "ArrowDown";
      if (className.includes("right")) return "ArrowRight";
      return null;
    })
    .filter((direction) => direction !== null);

  // GAME STATE
  let step = 1;
  let userScore = 0;
  let enemyScore = 0;

  // GAME LOGIC
  import { measureDistance } from "../../utils/measureDistance.ts";
  document.addEventListener("keydown", (event) => {
    event.preventDefault();
    playSound("click"); // Jouer le son de clic pour chaque touche pressée

    // Check if the pressed key is one of the arrow keys
    const validKeys = ["ArrowLeft", "ArrowUp", "ArrowDown", "ArrowRight"];
    if (!validKeys.includes(event.key)) {
      return;
    }

    console.log(step);
    if (step > randomArrows.length) return;

    const currentArrow = randomArrows[step - 1];
    if (event.key.toLowerCase() === currentArrow.toLowerCase()) {
      const distance = measureDistance(
        ".target-box",
        `.game__arrow-box--${step}`,
      );
      console.log("step", step);
      if (!distance) return;

      if (distance >= -20 && distance <= 20) {
        userScore++;
        playSound("correct"); // Jouer le son correct
      } else {
        enemyScore++;
        playSound("wrong"); // Jouer le son incorrect
      }

      step++;
    } else {
      enemyScore++;
      playSound("wrong"); // Jouer le son incorrect
      step++;
    }
    console.log("SCORE:", userScore, " / ", enemyScore);
    if (userScore === 6) {
      alert("You win!");
    } else if (enemyScore === 6) {
      alert("You lose!");
    }
  });

  // START GAME
  const arrowBoxes = document.querySelectorAll(".game__arrow-box");
  const startButton = document.querySelector(".game__button--start");

  startButton?.addEventListener("click", () => {
    arrowBoxes.forEach((arrowBox) => {
      arrowBox.classList.add("game__arrow-box--active");
    });
  });

  // RESET GAME
  const resetButton = document.querySelector(".game__button--reset");
  resetButton?.addEventListener("click", () => {
    window.location.reload();
  });
</script>

<style>
  .game {
    position: relative;

    margin: 64px 0;
    padding: 32px;

    overflow: hidden;

    width: 100%;
    min-height: 600px;

    background-color: var(--COD-Black);
  }

  .game__Arrow-Container {
    display: flex;
    gap: 1rem;
  }

  :root {
    --game-arrow-gap: 200px;
    --game-arrow-width: 106px;
    --game-arrow-offset: 200px;
  }
  .game__arrow-box--1 {
    left: calc(var(--game-arrow-offset) + var(--game-arrow-width));
  }
  .game__arrow-box--2 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap)
    );
  }
  .game__arrow-box--3 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap) *
        2
    );
  }
  .game__arrow-box--4 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap) *
        3
    );
  }
  .game__arrow-box--5 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap) *
        4
    );
  }
  .game__arrow-box--6 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap) *
        5
    );
  }
  .game__arrow-box--7 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap) *
        6
    );
  }
  .game__arrow-box--8 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap) *
        7
    );
  }
  .game__arrow-box--9 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap) *
        8
    );
  }
  .game__arrow-box--10 {
    left: calc(
      var(--game-arrow-offset) + var(--game-arrow-width) + var(--game-arrow-gap) *
        9
    );
  }

  .game__arrow-box--active {
    transform: translateX(-2400px);
    transition: transform 20s linear;
  }
</style>
